#
# Change URL to the base DokuWiki url where the plugin is installed.
#!/bin/sh
#
# This hook should be placed in a bare tS translation repository and will
# notify the gitmerge plugin that updates are available.
#
# Change URL to the base DokuWiki url where the plugin is installed.
#

# set base DokuWiki URL
URL=http://test.door43.org

# ***DO NOT CHANGE ANYTHING BELOW THIS LINE***

echo Triggering translation indexing.

# get repository name
PWD=$(pwd)
DIRS=(${PWD//\// })
LAST=$((${#DIRS[@]} - 1))
PROJECT_LANG=${DIRS[LAST]}
unset DIRS[LAST]
((LAST--))
DEVICE=$(echo ${DIRS[LAST]} | sed 's/[^a-zA-Z0-9]//g')
unset DIRS
unset LAST

# retrieve project and language id
PARTS=(${PROJECT_LANG//-/ })
LAST=$((${#PARTS[@]} - 1))
LANG=${PARTS[LAST]%.*}
unset PARTS[LAST]
((LAST--))
PROJECT=$(echo ${PARTS[LAST]})
unset PARTS
unset LAST

# get file list
PUBLISHED=$(git ls-tree master READY)
if [ -n "$PUBLISHED" ]
then
    # get commit when last published started
    LOG=$(git log -n1 --format=%H -- READY | awk '{print $1;}')
    COMMITS=(${LOG//\n/})
    LAST=$((${#COMMITS[@]} - 1))
    COMMIT=${COMMITS[LAST]}
    unset LAST

    # get HEAD commit id
    HEAD_COMMIT=$(git rev-parse HEAD)

    if [ "$COMMIT" == "$HEAD_COMMIT" ]
    then
        echo Finding changes since $COMMIT
        FILES=$(git diff --name-only $COMMIT^  HEAD | grep '\.txt$' | tr "\\n" "," | sed 's/\//-/g' | sed 's/\.txt//g' | sed 's/,$//'; echo '')
    else
        FILES=$(git diff --name-only HEAD^ HEAD | grep '\.txt$' | tr "\\n" "," | sed 's/\//-/g' | sed 's/\.txt//g' | sed 's/,$//'; echo '')
    fi

    echo Files changed: $FILES

    # set params
    PARAMS=$(echo call=door43gitmerge\&action=mark-updated\&lang=$LANG\&project=$PROJECT\&device=$DEVICE\&files=$FILES)

    echo Sending data...
    echo $PARAMS
    echo To $URL

    curl -H "X-Requested-With: XMLHttpRequest" --request POST --data "$PARAMS" --url $URL/lib/exe/ajax.php -v
else
    echo Indexing was not started because translation is not published
fi
